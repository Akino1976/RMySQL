# Static link on OSX
if [ $(echo "$OSTYPE" | grep "darwin") ]; then

  # Use system 'brew' if available
  if [ $(command -v brew) ]; then
    MYSQLBREWDIR="$(brew --prefix)/Cellar/mysql-connector-c/6.1.3";
    if [ ! -r "$MYSQLBREWDIR/include/mysql.h" ]; then
      echo "Brewing libmysql...";
      brew install ./tools/mysql-connector-c.rb;
    fi
    if [ -r "$MYSQLBREWDIR/include/mysql.h" ]; then
      echo "libmysql found in $MYSQLBREWDIR";
      echo "PKG_CPPFLAGS= -I$MYSQLBREWDIR/include" > src/Makevars

      # Force using the static library
      cp -f $MYSQLBREWDIR/lib/libmysqlclient.a ./src/
      echo "PKG_LIBS= -lz libmysqlclient.a" >> src/Makevars
      exit 0
    fi
  fi

  # Try brewing locally
  LOCALBREW="homebrew"
  if [ ! -r "$LOCALBREW/bin/brew" ]; then
     mkdir -p $LOCALBREW && curl -fsSL https://github.com/Homebrew/homebrew/tarball/master | tar xz --strip 1 -C $LOCALBREW
  fi
  if [ ! -r "$LOCALBREW/Cellar/mysql-connector-c/6.1.3/include/mysql.h" ]; then
     HOMEBREW_CACHE="/tmp" $LOCALBREW/bin/brew install ./tools/mysql-connector-c.rb;
  fi
  if [ -r "$LOCALBREW/Cellar/mysql-connector-c/6.1.3/include/mysql.h" ]; then
    echo "PKG_CPPFLAGS= -I../$LOCALBREW/Cellar/mysql-connector-c/6.1.3/include/" > src/Makevars
    echo "PKG_LIBS= -lz libmysqlclient.a" >> src/Makevars
    cp -f $LOCALBREW/Cellar/mysql-connector-c/6.1.3/lib/libmysqlclient.a ./src/
    exit 0;
  fi
  echo "Failed to install mysql-connector-c."
  echo "Please install brew and run: brew install mysql-connector-c."
  exit 1
fi

# For backward compatibility with the old autoconf script
if [ "$MYSQL_DIR" ]; then
  echo "PKG_CPPFLAGS= -I$MYSQL_DIR/include" > src/Makevars
elif [ "$MYSQL_INC" ]; then
  echo "PKG_CPPFLAGS= -I$MYSQL_INC" > src/Makevars
elif [ ! -r /usr/include/mysql/mysql.h ] && [ ! -r /usr/local/include/mysql/mysql.h ]; then
  echo "File mysql.h not found. Make sure the mysql development library is installed, e.g. libmysqlclient-dev (deb) or mariadb-devel (rpm)."
  exit 1
fi

if [ "$MYSQL_DIR" ]; then
  echo "PKG_LIBS= -L$MYSQL_DIR/lib -lmysqlclient -lz" >> src/Makevars
elif [ "$MYSQL_LIB" ]; then
  echo "PKG_LIBS= -L$MYSQL_LIB -lmysqlclient -lz" >> src/Makevars
else
  echo "PKG_LIBS= -lmysqlclient -lz" >> src/Makevars
fi
